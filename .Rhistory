# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(10, 0.5)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, Inf)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(3, 4)
d <- r_ztbinom_book(n = 10000, p = 0.8, N = 3.17)
draws <- as.data.frame(d) |>
rename(draws = d)
draws |>
ggplot(aes(x = draws)) +
geom_histogram(binwidth = 1) +
theme_bw()
mean(draws$draws)
var(draws$draws)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(10, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, Inf)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(3, 4)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(10, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, Inf)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(3, 4)
# Initial Guess
start_guesses <- c(8, 0.7)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(8, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, Inf)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(3, 4)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(8, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, Inf)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(3, 4)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(8, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, Inf)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(2, 4)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(8, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, 1)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(2, 4)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(8, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, 1)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(2, 40)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(8, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, 1)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(3, 40)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(8, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, 1)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(30, 40)
d <- r_ztbinom_book(n = 10000, p = 0.33, N = 90)
draws <- as.data.frame(d) |>
rename(draws = d)
draws |>
ggplot(aes(x = draws)) +
geom_histogram(binwidth = 1) +
theme_bw()
mean(draws$draws)
var(draws$draws)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(8, 0.7)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, 1)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(2, 4)
d <- r_ztbinom_book(n = 10000, p = 1, N = 2)
draws <- as.data.frame(d) |>
rename(draws = d)
draws |>
ggplot(aes(x = draws)) +
geom_histogram(binwidth = 1) +
theme_bw()
mean(draws$draws)
var(draws$draws)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(10, 0.5)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, 1)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(2, 4)
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean)^2 + (theo_var - observed_var)^2
return(error)
}
# Initial Guess
start_guesses <- c(10, 0.5)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, 1)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(2, 4)
library(dplyr)
library(purrr)
library(knitr)
# ---------------------------------------------------------
# 3. Diagnostic Test Suite
# ---------------------------------------------------------
# Define a set of target Means and Variances to test
# Note: For Negative Binomial, Variance usually must be > Mean
test_scenarios <- tribble(
~Target_Mean, ~Target_Var,
1.5,          2.0,
2.0,          4.0,
5.0,          10.0,
10.0,         15.0,
10.0,         30.0,
20.0,         40.0
)
# Function to run a single diagnostic row
run_diagnostic <- function(t_mean, t_var) {
# 1. Solve for N and P
params <- find_parameters(t_mean, t_var)
est_n <- params$Estimated_N
est_p <- params$Estimated_P
# 2. Prepare inputs for simulation
# The simulation function requires a whole number for N
n_rounded <- round(est_n)
# Ensure N is at least 1
if(n_rounded < 1) n_rounded <- 1
# 3. Generate Simulation
# Using the user's r_ztbinom_book function
# We generate a large sample size (n=50,000) to ensure stability of the sim mean/var
sim_values <- r_ztbinom_book(n = 50000, p = est_p, N = n_rounded)
# 4. Calculate Simulated Metrics
sim_mean <- mean(sim_values)
sim_var  <- var(sim_values)
# 5. Return Row
tibble(
Input_Mean = t_mean,
Input_Var  = t_var,
Est_N      = est_n,
Est_P      = est_p,
Sim_Input_N = n_rounded,
Sim_Mean   = sim_mean,
Sim_Var    = sim_var,
# Calculate % error between Input Mean and Sim Mean
Mean_Diff_Pct = paste0(round(((sim_mean - t_mean) / t_mean) * 100, 2), "%")
)
}
# Execute the tests across all scenarios
results_table <- test_scenarios |>
pmap_dfr(function(Target_Mean, Target_Var) {
run_diagnostic(Target_Mean, Target_Var)
})
# ---------------------------------------------------------
# 4. Output Formatted Table
# ---------------------------------------------------------
results_table |>
kable(
digits = 3,
caption = "Diagnostic Results: Optimizer vs Simulation (Rounded N)",
col.names = c("Input Mean", "Input Var", "Est N", "Est P",
"Rounded N", "Sim Mean", "Sim Var", "Mean % Error")
)
results_table
# ---------------------------------------------------------
# 2. The Optimizer (Solving for N, P)
# ---------------------------------------------------------
find_parameters <- function(observed_mean, observed_var) {
# Objective: Minimize the difference between Theoretical (Eq 41) and Observed
objective_fn <- function(params) {
N <- params[1]
P <- params[2]
theo_mean <- mean_tnb(N, P)
theo_var  <- variance_tnb(N, P)
# Squared Error Cost
error <- (theo_mean - observed_mean) + (theo_var - observed_var)
return(error)
}
# Initial Guess
start_guesses <- c(10, 0.5)
result <- optim(
par = start_guesses,
fn = objective_fn,
method = "L-BFGS-B",
lower = c(0.001, 0.001), # Parameters must be positive
upper = c(Inf, 1)
)
return(list(
Estimated_N = result$par[1],
Estimated_P = result$par[2],
Goodness_of_Fit = result$value # Closer to 0 is better
))
}
find_parameters(2, 4)
